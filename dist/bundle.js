(()=>{"use strict";const t=window.ecs;t.registerComponent({name:"Coaching Overlay",schema:{scene:t.eid},stateMachine:({world:e,eid:i,schemaAttribute:n})=>{t.defineState("default").initial().listen(e.events.globalId,t.events.REALITY_TRACKING_STATUS,a=>{const{scene:r}=n.get(i);"LIMITED"===a.data.status?(t.Hidden.remove(e,i),t.Hidden.set(e,r)):"NORMAL"===a.data.status&&(t.Hidden.set(e,i),t.Hidden.remove(e,r))})}});class e{constructor(t,e,i){this.terrainEid=t,this.world=e,this.THREE=i,this.active=!1,this.listeners=[],this.sf=null,this.tf=null,this._onStart=t=>{const e=Array.from(t.touches);if(e.length>=2){if(this.sf=null,!this.tf){const t=e[0],i=e[1],n=this._midpoint(t,i);this.tf={idA:t.identifier,idB:i.identifier,accumDx:0,accumDy:0,initSpread:this._spread(t,i),initScale:this._getScale(),prevAngle:this._angle(t,i),prevMidX:n.x,prevMidY:n.y,mode:"undecided"}}}else if(1===e.length&&!this.tf){const t=e[0];this.sf={id:t.identifier,lastX:t.clientX,lastY:t.clientY}}},this._onMove=t=>{t.preventDefault();const e=Array.from(t.touches);if(e.length>=2&&this.tf){const t=e.find(t=>t.identifier===this.tf.idA)??e[0],i=e.find(t=>t.identifier===this.tf.idB)??e[1],n=this._spread(t,i),a=this._angle(t,i),r=this._midpoint(t,i),s=Math.abs(r.x-this.tf.prevMidX),o=Math.abs(n-this.tf.initSpread);if("undecided"===this.tf.mode){if(this.tf.accumDx+=s,this.tf.accumDy+=Math.abs(n-(this.tf.initSpread+this.tf.accumDy)),this.tf.accumDx+o>=18){const t=this.tf.accumDx,e=o;t>1.8*e?this.tf.mode="rotation":e>1.8*t&&(this.tf.mode="scale",this.tf.initSpread=n,this.tf.initScale=this._getScale())}return this.tf.prevMidX=r.x,this.tf.prevMidY=r.y,void(this.tf.prevAngle=a)}if("rotation"===this.tf.mode){const t=r.x-this.tf.prevMidX;if(Math.abs(t)>.2){const e=t/(window.innerWidth||375)*Math.PI*2.5*.5;this.world.transform.rotateSelf(this.terrainEid,{x:0,y:Math.sin(e),z:0,w:Math.cos(e)})}}if("scale"===this.tf.mode){const t=n/this.tf.initSpread,e=Math.max(.02,Math.min(5,this.tf.initScale*t));this._setScale(e)}return this.tf.prevMidX=r.x,this.tf.prevMidY=r.y,void(this.tf.prevAngle=a)}if(this.sf&&1===e.length){const t=e.find(t=>t.identifier===this.sf.id);if(!t)return;const i=t.clientX-this.sf.lastX,n=t.clientY-this.sf.lastY;if(this.sf.lastX=t.clientX,this.sf.lastY=t.clientY,Math.abs(i)<.3&&Math.abs(n)<.3)return;const a=this._getCamera();if(!a)return;const{THREE:r}=this,s=new r.Vector3(0,0,-1).applyQuaternion(a.quaternion).setY(0).normalize(),o=new r.Vector3(1,0,0).applyQuaternion(a.quaternion).setY(0).normalize(),l=.005*-n,d=.005*i,c=this.world.transform.getWorldPosition(this.terrainEid);this.world.transform.setWorldPosition(this.terrainEid,{x:c.x+s.x*l+o.x*d,y:c.y,z:c.z+s.z*l+o.z*d})}},this._onEnd=t=>{const e=Array.from(t.touches);if(0===e.length)this.sf=null,this.tf=null;else if(1===e.length){this.tf=null;const t=e[0];this.sf={id:t.identifier,lastX:t.clientX,lastY:t.clientY}}},this._onCancel=t=>{this.sf=null,this.tf=null}}attach(){this.active||(this.active=!0,this._on(window,"touchstart",this._onStart,{passive:!1}),this._on(window,"touchmove",this._onMove,{passive:!1}),this._on(window,"touchend",this._onEnd,{passive:!1}),this._on(window,"touchcancel",this._onCancel,{passive:!1}))}detach(){this.active=!1;for(const[t,e,i]of this.listeners)t.removeEventListener(e,i);this.listeners=[],this.sf=null,this.tf=null}_on(t,e,i,n){t.addEventListener(e,i,n),this.listeners.push([t,e,i])}_spread(t,e){const i=t.clientX-e.clientX,n=t.clientY-e.clientY;return Math.sqrt(i*i+n*n)||1}_angle(t,e){return Math.atan2(e.clientY-t.clientY,e.clientX-t.clientX)}_midpoint(t,e){return{x:(t.clientX+e.clientX)/2,y:(t.clientY+e.clientY)/2}}_getScale(){const t=this.world.three.entityToObject.get(this.terrainEid);return t?.scale.x??1}_setScale(t){const e=this.world.three.entityToObject.get(this.terrainEid);e&&e.scale.set(t,t,t)}_getCamera(){let t=null;return this.world.three.scene.traverse(e=>{e.isCamera&&!t&&(t=e)}),t}}const i=(()=>{let t=!1;return()=>{if(t)return;t=!0;const e=document.createElement("style");e.textContent="\n      #terrain-ar-loader {\n        position: fixed;\n        inset: 0;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        gap: 20px;\n        pointer-events: none;\n        z-index: 9999;\n        transition: opacity 0.45s ease;\n      }\n      #terrain-ar-loader.hidden { opacity: 0; }\n\n      .ar-loader-orbit {\n        position: relative;\n        width: 48px;\n        height: 48px;\n      }\n      .ar-loader-ring {\n        position: absolute;\n        inset: 0;\n        border-radius: 50%;\n        border: 1.5px solid rgba(79,195,247,0.18);\n      }\n      .ar-loader-ball {\n        position: absolute;\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        background: #4fc3f7;\n        box-shadow: 0 0 10px rgba(79,195,247,0.7), 0 0 20px rgba(79,195,247,0.3);\n        top: -5px;\n        left: 50%;\n        transform-origin: 50% 29px;\n        animation: ar-ball-orbit 1.1s cubic-bezier(0.45,0.05,0.55,0.95) infinite;\n      }\n      @keyframes ar-ball-orbit {\n        from { transform: translateX(-50%) rotate(0deg); }\n        to   { transform: translateX(-50%) rotate(360deg); }\n      }\n      .ar-loader-label {\n        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        font-size: 11px;\n        font-weight: 300;\n        letter-spacing: 0.22em;\n        text-transform: uppercase;\n        color: rgba(232,244,255,0.55);\n        animation: ar-label-pulse 1.8s ease-in-out infinite;\n      }\n      @keyframes ar-label-pulse {\n        0%, 100% { opacity: 0.55; }\n        50%       { opacity: 1; }\n      }\n    ",document.head.appendChild(e)}})();class n{constructor(){this.loader=null,this._t1=0,this._t2=0}showLoader(){i(),this.loader||(this.loader=document.createElement("div"),this.loader.id="terrain-ar-loader",this.loader.innerHTML='\n      <div class="ar-loader-orbit">\n        <div class="ar-loader-ring"></div>\n        <div class="ar-loader-ball"></div>\n      </div>\n      <span class="ar-loader-label" id="ar-loader-text">Iniciando c√°mara</span>\n    ',document.body.appendChild(this.loader),this._t1=window.setTimeout(()=>{const t=document.getElementById("ar-loader-text");t&&(t.textContent="Detectando entorno")},4e3),this._t2=window.setTimeout(()=>{const t=document.getElementById("ar-loader-text");t&&(t.textContent="Preparando experiencia")},8e3))}hideLoader(){if(window.clearTimeout(this._t1),window.clearTimeout(this._t2),!this.loader)return;const t=this.loader;this.loader=null,t.classList.add("hidden"),setTimeout(()=>t.remove(),480)}}const a=.28,r=1e-5;t.registerComponent({name:"terrain-tap-place",schema:{ground:t.eid,terrainEntity:t.eid},schemaDefaults:{},data:{placed:t.boolean},stateMachine:({world:i,eid:s,schemaAttribute:o,dataAttribute:l})=>{const d=o.get(s),{THREE:c}=window,h=[];let p=null,m=!1;const u=new n,f=t.defineTrigger(),g=t.defineTrigger();t.defineState("loading").initial().onEnter(()=>{i.setPosition(d.terrainEntity,0,0,0),t.Scale.set(i,d.terrainEntity,{x:r,y:r,z:r}),t.Hidden.has(i,d.terrainEntity)&&t.Hidden.remove(i,d.terrainEntity),u.showLoader()}).onTick(()=>{(function(t,e){const i=t.three.entityToObject.get(e);if(!i)return!1;let n=!1;return i.traverse(t=>{n||t.isMesh&&t.geometry?.attributes&&Object.keys(t.geometry.attributes).length>0&&(n=!0)}),n})(i,d.terrainEntity)&&f.trigger()}).onTrigger(f,"scanning"),t.defineState("scanning").onEnter(()=>{u.hideLoader(),i.setPosition(d.terrainEntity,0,0,0),t.Scale.set(i,d.terrainEntity,{x:r,y:r,z:r}),m=!1,l.cursor(s).placed=!1}).onTick(()=>{const e=i.raycastFrom(s).filter(t=>t.eid===d.ground);if(0===e.length)return;const n=e[0].point,r=t.Position.get(i,s),{x:o,z:l}=function(t,e,i,n,a){const r=new t.Vector3(n-e,0,a-i);return r.lengthSq()<1e-4?{x:e,z:i}:(r.normalize(),{x:e+.6*r.x,z:i+.6*r.z})}(c,n.x,n.z,r.x,r.z),p=n.y+.01;if(!m){const t=i.three.entityToObject.get(d.terrainEntity)??null;t&&(function(t,e,i){i.length=0;const n=new t.MeshStandardMaterial({color:9350852,roughness:.75,metalness:.05,transparent:!0,opacity:.72});e.traverse(t=>{t.isMesh&&(i.push({mesh:t,original:Array.isArray(t.material)?t.material.slice():t.material}),t.material=Array.isArray(t.material)?t.material.map(()=>n):n)})}(c,t,h),m=!0)}i.setPosition(d.terrainEntity,o,p,l),t.Scale.set(i,d.terrainEntity,{x:a,y:a,z:a}),g.trigger()}).onTrigger(g,"placed"),t.defineState("placed").onEnter(()=>{!function(t){for(const{mesh:e,original:i}of t)e.material=i;t.length=0}(h),m=!1,p=new e(d.terrainEntity,i,c),p.attach()}).onExit(()=>{p?.detach(),p=null})},remove:()=>{}});class s{constructor(t,e){this.scene=t,this.THREE=e,this.points=null}create(){const{THREE:t}=this,e=s.DOT_COUNT,i=new Float32Array(3*e);for(let t=0;t<e;t++){const n=t/(e-1);i[3*t]=0,i[3*t+1]=n*s.TOWER_HEIGHT,i[3*t+2]=0}const n=new t.BufferGeometry;n.setAttribute("position",new t.BufferAttribute(i,3));const a=new t.PointsMaterial({color:16777215,size:s.DOT_SIZE,map:this._getSoftCircleTexture(),transparent:!0,opacity:s.DOT_OPACITY,depthWrite:!1,sizeAttenuation:!0,alphaTest:.01});this.points=new t.Points(n,a),this.scene.add(this.points)}update(t,e,i){this.points&&this.points.position.set(t,e,i)}setVisible(t){this.points&&(this.points.visible=t)}fadeAndDispose(t=350){if(!this.points)return;const e=this.points.material,i=performance.now(),n=s.DOT_OPACITY,a=()=>{const r=Math.min((performance.now()-i)/t,1);e.opacity=n*(1-r),r<1?requestAnimationFrame(a):this._dispose()};requestAnimationFrame(a)}dispose(){this._dispose()}_getSoftCircleTexture(){if(s.cachedTexture)return s.cachedTexture;const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);i.addColorStop(0,"rgba(255,255,255,1.00)"),i.addColorStop(.4,"rgba(255,255,255,0.95)"),i.addColorStop(.7,"rgba(255,255,255,0.40)"),i.addColorStop(1,"rgba(255,255,255,0.00)"),e.fillStyle=i,e.fillRect(0,0,64,64);const{THREE:n}=this;return s.cachedTexture=new n.CanvasTexture(t),s.cachedTexture}_dispose(){this.points&&(this.scene.remove(this.points),this.points.geometry.dispose(),this.points.material.dispose(),this.points=null)}}s.cachedTexture=null,s.DOT_COUNT=9,s.TOWER_HEIGHT=1.35,s.DOT_SIZE=.055,s.DOT_OPACITY=.92;class o{constructor(t,e){this.scene=t,this.THREE=e,this.mesh=null}create(){const{THREE:t}=this,e=new t.CircleGeometry(o.RADIUS,o.SEGMENTS),i=new t.MeshBasicMaterial({map:this._getTexture(),transparent:!0,opacity:o.OPACITY,depthWrite:!1,side:t.DoubleSide});this.mesh=new t.Mesh(e,i),this.mesh.rotation.x=-Math.PI/2,this.mesh.position.y=.002,this.scene.add(this.mesh)}update(t,e){this.mesh&&(this.mesh.position.x=t,this.mesh.position.z=e)}fadeAndDispose(t=350){if(!this.mesh)return;const e=this.mesh.material,i=performance.now(),n=o.OPACITY,a=()=>{const r=Math.min((performance.now()-i)/t,1);e.opacity=n*(1-r),r<1?requestAnimationFrame(a):this._dispose()};requestAnimationFrame(a)}dispose(){this._dispose()}_getTexture(){if(o.cachedTexture)return o.cachedTexture;const t=128,e=document.createElement("canvas");e.width=t,e.height=t;const i=e.getContext("2d"),n=i.createRadialGradient(64,64,0,64,64,64);n.addColorStop(0,"rgba(255,255,255,0.90)"),n.addColorStop(.35,"rgba(255,255,255,0.60)"),n.addColorStop(.7,"rgba(255,255,255,0.20)"),n.addColorStop(1,"rgba(255,255,255,0.00)"),i.fillStyle=n,i.fillRect(0,0,t,t);const{THREE:a}=this;return o.cachedTexture=new a.CanvasTexture(e),o.cachedTexture}_dispose(){this.mesh&&(this.scene.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.mesh=null)}}o.cachedTexture=null,o.RADIUS=.18,o.OPACITY=.55,o.SEGMENTS=48;const l=JSON.parse('{"entrySpaceId":"terrain-ar-space-01","objects":{"terrain-ar-camera-01":{"camera":{"allowedDevices":"any","type":"perspective","xr":{"phone":"AR","xrCameraType":"world","desktop":"disabled","headset":"disabled"}},"components":{"terrain-tap-place-comp-01":{"id":"terrain-tap-place-comp-01","name":"terrain-tap-place","parameters":{"ground":{"type":"entity","id":"terrain-ar-ground-01"},"terrainEntity":{"type":"entity","id":"terrain-ar-model-01"},"yHeight":0.005,"finalScale":1}}},"geometry":null,"id":"terrain-ar-camera-01","material":null,"name":"Camera","order":1,"parentId":"terrain-ar-space-01","position":[0,2,2],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ambient-01":{"components":{},"geometry":null,"id":"terrain-ar-ambient-01","light":{"type":"ambient","intensity":1.2},"material":null,"name":"Ambient Light","order":2,"parentId":"terrain-ar-space-01","position":[0,5,0],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-dirlight-01":{"components":{},"id":"terrain-ar-dirlight-01","light":{"castShadow":true,"color":"#ffffff","intensity":1,"type":"directional","shadowAutoUpdate":true,"shadowBias":0.001,"shadowMapSize":[1024,1024],"shadowCameraLeft":-5,"shadowCameraRight":5,"shadowCameraTop":5,"shadowCameraBottom":-5,"shadowCameraNear":0.5,"shadowCameraFar":50,"targetX":0,"targetY":0,"targetZ":0},"name":"Directional Light","order":2.5,"parentId":"terrain-ar-space-01","position":[10,15,8],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ground-01":{"components":{},"geometry":{"height":1000,"type":"plane","width":1000},"id":"terrain-ar-ground-01","material":{"color":"#000000","opacity":0,"side":"double","transparent":true,"type":"shadow"},"name":"Ground","order":3,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[-0.7071068,0,0,0.7071068],"scale":[1,1,1],"shadow":{"receiveShadow":true}},"terrain-ar-model-01":{"components":{},"gltfModel":{"animationClip":"","loop":false,"src":{"type":"asset","asset":"assets/terrain_optimized3.glb"}},"id":"terrain-ar-model-01","name":"Terrain Model","order":4,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[0,0,0,1],"scale":[1,1,1],"shadow":{"castShadow":true,"receiveShadow":true}}},"runtimeVersion":{"type":"version","level":"major","major":2,"minor":0,"patch":0},"spaces":{"terrain-ar-space-01":{"activeCamera":"terrain-ar-camera-01","id":"terrain-ar-space-01","name":"Terrain AR","reflections":{"type":"url","url":"https://cdn.8thwall.com/web/assets/envmap/basic_env_map-m9hqpneh.jpg"}}},"historyVersion":"terrain-ar-v1"}');delete l.history,delete l.historyVersion,window.ecs.application.init(l)})();