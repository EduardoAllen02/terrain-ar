(()=>{"use strict";const e=window.ecs;e.registerComponent({name:"Coaching Overlay",schema:{scene:e.eid},stateMachine:({world:t,eid:n,schemaAttribute:i})=>{e.defineState("default").initial().listen(t.events.globalId,e.events.REALITY_TRACKING_STATUS,a=>{const{scene:r}=i.get(n);"LIMITED"===a.data.status?(e.Hidden.remove(t,n),e.Hidden.set(t,r)):"NORMAL"===a.data.status&&(e.Hidden.set(t,n),e.Hidden.remove(t,r))})}});class t{constructor(e,t,n){this.terrainEid=e,this.world=t,this.THREE=n,this.active=!1,this.listeners=[],this.sf=null,this.tf=null,this._onStart=e=>{const t=Array.from(e.touches);if(t.length>=2){if(this.sf=null,!this.tf){const e=t[0],n=t[1],i=this._spread(e,n);this.tf={idA:e.identifier,idB:n.identifier,prevAngle:this._angle(e,n),prevSpread:i,baseScale:this._getScale(),initSpread:i}}}else if(1===t.length&&!this.tf){const e=t[0],n=this._hitTestModel(e.clientX,e.clientY);this.sf={id:e.identifier,lastX:e.clientX,lastY:e.clientY,mode:n?"pan":"rotate"}}},this._onMove=e=>{e.preventDefault();const t=Array.from(e.touches);if(t.length>=2&&this.tf){const e=t.find(e=>e.identifier===this.tf.idA)??t[0],n=t.find(e=>e.identifier===this.tf.idB)??t[1],i=this._angle(e,n),a=this._spread(e,n);if(a>10&&this.tf.initSpread>10){const e=a/this.tf.initSpread,t=Math.max(.02,Math.min(5,this.tf.baseScale*e));this._setScale(t)}return this.tf.prevAngle=i,void(this.tf.prevSpread=a)}if(this.sf&&1===t.length){const e=t.find(e=>e.identifier===this.sf.id);if(!e)return;const n=e.clientX-this.sf.lastX,i=e.clientY-this.sf.lastY;if(this.sf.lastX=e.clientX,this.sf.lastY=e.clientY,Math.abs(n)<.3&&Math.abs(i)<.3)return;if("pan"===this.sf.mode){const e=this._getCamera();if(!e)return;const{THREE:t}=this,a=new t.Vector3(0,0,-1).applyQuaternion(e.quaternion).setY(0).normalize(),r=new t.Vector3(1,0,0).applyQuaternion(e.quaternion).setY(0).normalize(),s=.005*-i,o=.005*n,l=this.world.transform.getWorldPosition(this.terrainEid);return void this.world.transform.setWorldPosition(this.terrainEid,{x:l.x+a.x*s+r.x*o,y:l.y,z:l.z+a.z*s+r.z*o})}if("rotate"===this.sf.mode&&Math.abs(n)>.3){const e=.008*n*.5;this.world.transform.rotateSelf(this.terrainEid,{x:0,y:Math.sin(e),z:0,w:Math.cos(e)})}}},this._onEnd=e=>{const t=Array.from(e.touches);if(0===t.length)this.sf=null,this.tf=null;else if(1===t.length){this.tf=null;const e=t[0],n=this._hitTestModel(e.clientX,e.clientY);this.sf={id:e.identifier,lastX:e.clientX,lastY:e.clientY,mode:n?"pan":"rotate"}}},this._onCancel=e=>{this.sf=null,this.tf=null}}attach(){this.active||(this.active=!0,this._on(window,"touchstart",this._onStart,{passive:!1}),this._on(window,"touchmove",this._onMove,{passive:!1}),this._on(window,"touchend",this._onEnd,{passive:!1}),this._on(window,"touchcancel",this._onCancel,{passive:!1}))}detach(){this.active=!1;for(const[e,t,n]of this.listeners)e.removeEventListener(t,n);this.listeners=[],this.sf=null,this.tf=null}_on(e,t,n,i){e.addEventListener(t,n,i),this.listeners.push([e,t,n])}_spread(e,t){const n=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(n*n+i*i)}_angle(e,t){return Math.atan2(t.clientY-e.clientY,t.clientX-e.clientX)}_angleDelta(e,t){let n=t-e;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;return n}_getScale(){const e=window.ecs;if(e?.Scale?.has(this.world,this.terrainEid))return e.Scale.get(this.world,this.terrainEid).x;const t=this.world.three.entityToObject.get(this.terrainEid);return t?.scale.x??1}_setScale(e){const t=window.ecs;if(t?.Scale)t.Scale.set(this.world,this.terrainEid,{x:e,y:e,z:e});else{const t=this.world.three.entityToObject.get(this.terrainEid);t&&t.scale.set(e,e,e)}}_hitTestModel(e,t){const n=this._getCamera();if(!n)return!1;const i=this.world.three.entityToObject.get(this.terrainEid);if(!i)return!1;const{THREE:a}=this,r=e/window.innerWidth*2-1,s=-t/window.innerHeight*2+1,o=new a.Raycaster;o.setFromCamera({x:r,y:s},n);const l=[];return i.traverse(e=>{e.isMesh&&l.push(e)}),o.intersectObjects(l,!1).length>0}_getCamera(){let e=null;return this.world.three.scene.traverse(t=>{t.isCamera&&!e&&(e=t)}),e}}const n=(()=>{let e=!1;return()=>{if(e)return;e=!0;const t=document.createElement("style");t.textContent="\n      #terrain-ar-loader {\n        position: fixed; inset: 0;\n        display: flex; flex-direction: column;\n        align-items: center; justify-content: center;\n        gap: 20px; pointer-events: none;\n        z-index: 9999; transition: opacity 0.45s ease;\n        background: transparent;\n      }\n      #terrain-ar-loader.hidden { opacity: 0; }\n\n      .ar-loader-orbit { position: relative; width: 48px; height: 48px; }\n      .ar-loader-ring {\n        position: absolute; inset: 0; border-radius: 50%;\n        border: 1.5px solid rgba(79,195,247,0.18);\n      }\n      .ar-loader-ball {\n        position: absolute; width: 10px; height: 10px;\n        border-radius: 50%; background: #4fc3f7;\n        box-shadow: 0 0 10px rgba(79,195,247,0.7), 0 0 20px rgba(79,195,247,0.3);\n        top: -5px; left: 50%; transform-origin: 50% 29px;\n        animation: ar-ball-orbit 1.1s cubic-bezier(0.45,0.05,0.55,0.95) infinite;\n      }\n      @keyframes ar-ball-orbit {\n        from { transform: translateX(-50%) rotate(0deg); }\n        to   { transform: translateX(-50%) rotate(360deg); }\n      }\n      .ar-loader-label {\n        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        font-size: 11px; font-weight: 300;\n        letter-spacing: 0.22em; text-transform: uppercase;\n        color: rgba(232,244,255,0.55);\n        animation: ar-label-pulse 1.8s ease-in-out infinite;\n      }\n      @keyframes ar-label-pulse {\n        0%, 100% { opacity: 0.55; }\n        50%       { opacity: 1; }\n      }\n\n      /* â”€â”€ Reset button â”€â”€ */\n      #ar-reset-btn {\n        position: fixed;\n        bottom: 32px;\n        right: 20px;\n        z-index: 9998;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        background: rgba(255,255,255,0.88);\n        border: none;\n        border-radius: 22px;\n        padding: 10px 16px 10px 12px;\n        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        font-size: 12px;\n        font-weight: 500;\n        letter-spacing: 0.06em;\n        text-transform: uppercase;\n        color: #4ab8d8;\n        cursor: pointer;\n        box-shadow: 0 2px 14px rgba(0,0,0,0.18);\n        -webkit-tap-highlight-color: transparent;\n        transition: background 0.15s, opacity 0.25s;\n        opacity: 0; pointer-events: none;\n      }\n      #ar-reset-btn.ar-reset-visible { opacity: 1; pointer-events: all; }\n      #ar-reset-btn:active { background: rgba(235,248,255,0.98); }\n      #ar-reset-btn svg { color: #4ab8d8; flex-shrink: 0; }\n    ",document.head.appendChild(t)}})();class i{constructor(){this.loader=null,this.resetBtn=null,this._t1=0,this._t2=0}showLoader(){n(),this.loader||(this.loader=document.createElement("div"),this.loader.id="terrain-ar-loader",this.loader.innerHTML='\n      <div class="ar-loader-orbit">\n        <div class="ar-loader-ring"></div>\n        <div class="ar-loader-ball"></div>\n      </div>\n      <span class="ar-loader-label" id="ar-loader-text">Iniciando cÃ¡mara</span>\n    ',document.body.appendChild(this.loader),this._t1=window.setTimeout(()=>{const e=document.getElementById("ar-loader-text");e&&(e.textContent="Detectando entorno")},4e3),this._t2=window.setTimeout(()=>{const e=document.getElementById("ar-loader-text");e&&(e.textContent="Preparando experiencia")},8e3))}showRescanLoader(){n(),this.loader||(this.loader=document.createElement("div"),this.loader.id="terrain-ar-loader",this.loader.innerHTML='\n      <div class="ar-loader-orbit">\n        <div class="ar-loader-ring"></div>\n        <div class="ar-loader-ball"></div>\n      </div>\n      <span class="ar-loader-label" id="ar-loader-text">Detectando entorno</span>\n    ',document.body.appendChild(this.loader))}hideLoader(){if(window.clearTimeout(this._t1),window.clearTimeout(this._t2),!this.loader)return;const e=this.loader;this.loader=null,e.classList.add("hidden"),setTimeout(()=>e.remove(),480)}showResetButton(e){if(n(),this.resetBtn)return;const t=document.createElement("button");t.id="ar-reset-btn",t.innerHTML='\n      <svg width="15" height="15" viewBox="0 0 24 24" fill="none"\n           stroke="currentColor" stroke-width="2.2"\n           stroke-linecap="round" stroke-linejoin="round">\n        <polyline points="1 4 1 10 7 10"/>\n        <path d="M3.51 15a9 9 0 1 0 .49-5"/>\n      </svg>\n      Reiniciar\n    ',document.body.appendChild(t),this.resetBtn=t,requestAnimationFrame(()=>t.classList.add("ar-reset-visible")),t.addEventListener("click",()=>{this.hideResetButton(),e()})}hideResetButton(){if(!this.resetBtn)return;const e=this.resetBtn;this.resetBtn=null,e.classList.remove("ar-reset-visible"),setTimeout(()=>e.remove(),280)}}const a={hotspot:"assets/pois/hotspot/",mountain:"assets/pois/mountain/",pin:"assets/pois/pin/"},r={hotspot:"hotspot_",mountain:"mountain_",pin:"pin_"};class s{constructor(e,t={}){this.THREE=e,this.billboards=[],this._tapStart=null,this._tapListener=null,this._tapEndListener=null,this.opts={baseSize:t.baseSize??.1,verticalOffset:t.verticalOffset??.025,debug:t.debug??!1,onHotspotTap:t.onHotspotTap??(()=>{})}}async init(e,t){const{THREE:n,opts:i}=this;this._v3=new n.Vector3,this._scale=new n.Vector3;const s=new n.TextureLoader,o=[],l=[];return e.traverse(e=>{const n=this._detectType(e.name);if(!n)return;const d=r[n],c=e.name.slice(d.length),h=`${a[n]}${c}.png`;"hotspot"===n&&l.push(c),o.push(new Promise(a=>{s.load(h,i=>{const r=this._makeSprite(i);t.add(r),this.billboards.push({sprite:r,anchor:e,name:c,type:n}),a()},void 0,()=>{if(i.debug){const i=this._makeDebugSprite(c,n);t.add(i),this.billboards.push({sprite:i,anchor:e,name:c,type:n})}a()})}))}),await Promise.all(o),this._attachTapListener(),l}update(e){const{opts:t,_v3:n,_scale:i}=this;e.getWorldScale(i);const a=i.x;for(const{sprite:e,anchor:i}of this.billboards){i.getWorldPosition(n),n.y+=t.verticalOffset*a,e.position.copy(n);const r=t.baseSize*a,s=this._getAspect(e);e.scale.set(r*s,r,1)}}dispose(e){this._detachTapListener();for(const{sprite:t}of this.billboards)e.remove(t),t.material.map?.dispose(),t.material.dispose();this.billboards=[]}getSprite(e){return this.billboards.find(t=>t.name===e)?.sprite}_attachTapListener(){this._tapListener=e=>{1===e.touches.length&&(this._tapStart={x:e.touches[0].clientX,y:e.touches[0].clientY,t:Date.now()})},this._tapEndListener=e=>{if(!this._tapStart)return;const t=this._tapStart;this._tapStart=null;const n=e.changedTouches[0],i=Math.hypot(n.clientX-t.x,n.clientY-t.y);Date.now()-t.t>300||i>10||this._checkHotspotHit(n.clientX,n.clientY)},window.addEventListener("touchstart",this._tapListener,{passive:!0}),window.addEventListener("touchend",this._tapEndListener,{passive:!0})}_detachTapListener(){this._tapListener&&window.removeEventListener("touchstart",this._tapListener),this._tapEndListener&&window.removeEventListener("touchend",this._tapEndListener),this._tapListener=this._tapEndListener=null}_checkHotspotHit(e,t){const n=this.billboards.filter(e=>"hotspot"===e.type&&e.sprite.visible);if(!n.length)return;const i=this._getCamera();if(!i)return;const a=new this.THREE.Vector2(e/window.innerWidth*2-1,-t/window.innerHeight*2+1),r=44/window.innerWidth*2;let s=null,o=1/0;for(const e of n){const t=e.sprite.position.clone().project(i),n=a.distanceTo(new this.THREE.Vector2(t.x,t.y));n<r&&n<o&&(s=e,o=n)}s&&this.opts.onHotspotTap(s.name)}_getCamera(){let e=null;return this.billboards[0]?.sprite.parent?.traverse?.(t=>{t.isCamera&&!e&&(e=t)}),e}_detectType(e){for(const[t,n]of Object.entries(r))if(e.startsWith(n))return t;return null}_makeSprite(e){const{THREE:t}=this;e.colorSpace=t.SRGBColorSpace??t.sRGBEncoding;const n=new t.SpriteMaterial({map:e,transparent:!0,depthTest:!1,depthWrite:!1,sizeAttenuation:!0}),i=new t.Sprite(n);return i.renderOrder=999,i}_makeDebugSprite(e,t){const n=document.createElement("canvas");n.width=256,n.height=64;const i=n.getContext("2d");return i.fillStyle={hotspot:"rgba(255,140,0,0.9)",mountain:"rgba(80,140,255,0.9)",pin:"rgba(60,200,120,0.9)"}[t],i.fillRect(0,0,256,64),i.fillStyle="#fff",i.font="bold 20px sans-serif",i.textAlign="center",i.fillText(e,128,40),this._makeSprite(new this.THREE.CanvasTexture(n))}_getAspect(e){const t=e.material.map?.image;return t?.height?t.width/t.height:2}}class o{constructor(){this.names=[],this.idx=0}register(e){this.names=[...e].sort(),this.idx=0}setCurrent(e){const t=this.names.indexOf(e);-1!==t&&(this.idx=t)}getCurrentName(){return this.names[this.idx]??null}getCount(){return this.names.length}navigatePrev(){return this.names.length?(this.idx=(this.idx-1+this.names.length)%this.names.length,this.names[this.idx]):null}navigateNext(){return this.names.length?(this.idx=(this.idx+1)%this.names.length,this.names[this.idx]):null}}function l(e){!function(){if(document.getElementById("dc-styles"))return;const e=document.createElement("style");e.id="dc-styles",e.textContent="\n  #dc-overlay {\n    position: fixed; inset: 0; z-index: 999999;\n    display: flex; align-items: center; justify-content: center;\n    background: rgba(0,8,20,0.82); backdrop-filter: blur(6px);\n    opacity: 0; transition: opacity 0.3s ease; pointer-events: none;\n  }\n  #dc-overlay.dc-show { opacity: 1; pointer-events: all; }\n\n  #dc-card {\n    background: rgba(255,255,255,0.97);\n    border-radius: 20px;\n    padding: 28px 24px 22px;\n    max-width: 320px; width: 88%;\n    display: flex; flex-direction: column; align-items: center; gap: 14px;\n    box-shadow: 0 8px 40px rgba(0,0,0,0.28);\n    transform: translateY(12px); transition: transform 0.3s ease;\n  }\n  #dc-overlay.dc-show #dc-card { transform: translateY(0); }\n\n  #dc-icon {\n    width: 52px; height: 52px; border-radius: 50%;\n    display: flex; align-items: center; justify-content: center;\n    font-size: 26px;\n  }\n  #dc-icon.warn { background: rgba(255,180,0,0.15); }\n  #dc-icon.error { background: rgba(255,70,70,0.12); }\n\n  #dc-title {\n    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n    font-size: 16px; font-weight: 600;\n    color: #1a2a3a; text-align: center; line-height: 1.3;\n  }\n  #dc-msg {\n    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n    font-size: 13px; font-weight: 400;\n    color: #5a6a7a; text-align: center; line-height: 1.55;\n  }\n  #dc-btn-primary {\n    width: 100%; padding: 13px;\n    background: #4ab8d8; border: none; border-radius: 12px;\n    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n    font-size: 14px; font-weight: 600; letter-spacing: 0.04em;\n    color: #fff; cursor: pointer;\n    -webkit-tap-highlight-color: transparent;\n    transition: background 0.15s;\n  }\n  #dc-btn-primary:active { background: #37a5c5; }\n  #dc-btn-secondary {\n    background: none; border: none;\n    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n    font-size: 12px; font-weight: 400; letter-spacing: 0.06em;\n    color: #8a9aaa; text-transform: uppercase; cursor: pointer;\n    padding: 4px 8px;\n    -webkit-tap-highlight-color: transparent;\n  }\n",document.head.appendChild(e)}(),document.getElementById("dc-overlay")?.remove();const t=document.createElement("div");t.id="dc-overlay",t.innerHTML=`\n    <div id="dc-card">\n      <div id="dc-icon ${e.iconType}">${e.icon}</div>\n      <div id="dc-title">${e.title}</div>\n      <div id="dc-msg">${e.message}</div>\n      <button id="dc-btn-primary">${e.primary}</button>\n      ${e.secondary?`<button id="dc-btn-secondary">${e.secondary}</button>`:""}\n    </div>\n  `,document.body.appendChild(t),requestAnimationFrame(()=>t.classList.add("dc-show")),t.querySelector("#dc-btn-primary").addEventListener("click",()=>{t.classList.remove("dc-show"),setTimeout(()=>t.remove(),320),e.onPrimary()}),e.secondary&&e.onSecondary&&t.querySelector("#dc-btn-secondary").addEventListener("click",()=>{t.classList.remove("dc-show"),setTimeout(()=>t.remove(),320),e.onSecondary()})}const d=(()=>{let e=!1;return()=>{if(e)return;e=!0;const t=document.createElement("style");t.textContent="\n      #v360-overlay {\n        position: fixed; inset: 0; z-index: 99999;\n        background: #000;\n        opacity: 0; transition: opacity 0.35s ease;\n        touch-action: none;\n      }\n      #v360-overlay.v360-visible { opacity: 1; }\n      #v360-canvas {\n        position: absolute; inset: 0;\n        width: 100%; height: 100%; display: block;\n      }\n      #v360-topbar {\n        position: absolute; top: 0; left: 0; right: 0;\n        display: flex; align-items: center; justify-content: center;\n        padding: 18px 16px 0;\n        pointer-events: none; z-index: 2;\n      }\n      #v360-back {\n        position: absolute; left: 16px;\n        display: flex; align-items: center; gap: 6px;\n        background: rgba(255,255,255,0.92); border: none; border-radius: 22px;\n        padding: 8px 16px 8px 10px;\n        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        font-size: 13px; font-weight: 500; color: #4ab8d8;\n        letter-spacing: 0.04em; cursor: pointer; pointer-events: all;\n        box-shadow: 0 2px 12px rgba(0,0,0,0.18);\n        -webkit-tap-highlight-color: transparent;\n        transition: background 0.15s;\n      }\n      #v360-back:active { background: rgba(235,248,255,0.98); }\n      #v360-title {\n        background: rgba(255,255,255,0.92); border-radius: 18px;\n        padding: 7px 18px;\n        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        font-size: 13px; font-weight: 500;\n        letter-spacing: 0.12em; text-transform: uppercase; color: #4ab8d8;\n        box-shadow: 0 2px 12px rgba(0,0,0,0.18);\n        max-width: 48vw; white-space: nowrap;\n        overflow: hidden; text-overflow: ellipsis;\n      }\n      .v360-nav {\n        position: absolute; top: 50%; transform: translateY(-50%);\n        z-index: 2; background: rgba(255,255,255,0.92); border: none;\n        border-radius: 50%; width: 48px; height: 48px;\n        display: flex; align-items: center; justify-content: center;\n        cursor: pointer; box-shadow: 0 2px 12px rgba(0,0,0,0.22);\n        -webkit-tap-highlight-color: transparent;\n        transition: background 0.15s, transform 0.15s;\n      }\n      .v360-nav:active {\n        background: rgba(235,248,255,0.98);\n        transform: translateY(-50%) scale(0.93);\n      }\n      #v360-prev { left: 14px; }\n      #v360-next { right: 14px; }\n      .v360-nav svg { color: #4ab8d8; }\n      #v360-counter {\n        position: absolute; bottom: 28px; left: 50%; transform: translateX(-50%);\n        display: flex; gap: 6px; z-index: 2;\n      }\n      .v360-dot {\n        width: 6px; height: 6px; border-radius: 50%;\n        background: rgba(255,255,255,0.35); transition: background 0.2s;\n      }\n      .v360-dot.active { background: rgba(255,255,255,0.95); }\n      #v360-hint {\n        position: absolute; bottom: 52px; left: 50%; transform: translateX(-50%);\n        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        font-size: 10px; font-weight: 300;\n        letter-spacing: 0.18em; text-transform: uppercase;\n        color: rgba(255,255,255,0.45); white-space: nowrap;\n        pointer-events: none; z-index: 2; transition: opacity 0.5s;\n      }\n      #v360-hint.v360-hidden { opacity: 0; }\n      #v360-loading {\n        position: absolute; inset: 0;\n        display: flex; align-items: center; justify-content: center;\n        background: rgba(0,0,0,0.55); z-index: 3; transition: opacity 0.3s;\n      }\n      #v360-loading.v360-hidden { opacity: 0; pointer-events: none; }\n      .v360-spinner {\n        width: 32px; height: 32px;\n        border: 2px solid rgba(74,184,216,0.25);\n        border-top-color: #4ab8d8; border-radius: 50%;\n        animation: v360-spin 0.8s linear infinite;\n      }\n      @keyframes v360-spin { to { transform: rotate(360deg); } }\n      #v360-gyro-badge {\n        position: absolute; top: 72px; right: 14px;\n        background: rgba(0,0,0,0.45); border-radius: 12px;\n        padding: 5px 10px; z-index: 2;\n        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase;\n        color: rgba(255,255,255,0.55); pointer-events: none;\n      }\n    ",document.head.appendChild(t)}})();class c{constructor(e){this.THREE=e,this.overlay=null,this.renderer=null,this.scene=null,this.camera=null,this.sphere=null,this.texLoader=null,this.rafId=0,this.texCache=new Map,this._gyroHandler=null,this._alpha=0,this._beta=90,this._gamma=0,this._gyroOk=!1,this._euler=null,this._q1=null,this._qOrient=null,this._zee=null,this._drag={active:!1,lastX:0,lastY:0,lon:0,lat:0},this._onTouchStart=null,this._onTouchMove=null,this._onTouchEnd=null}async open(e,t,n){d(),t.setCurrent(e);const i=await this._requestGyroPermission();this._buildOverlay(e,t,i,n),this._initRenderer(),i?this._startGyro():this._startTouchDrag(),this._startLoop(),await this._loadImage(e),this._hideLoading(),this._hideHintAfterDelay()}close(e){cancelAnimationFrame(this.rafId),this._stopGyro(),this._stopTouchDrag();const t=this.overlay;t&&(t.classList.remove("v360-visible"),setTimeout(()=>{t.remove(),this._fullDispose()},380)),this.overlay=null,e()}_buildOverlay(e,t,n,i){const a=t.getCount(),r=n?"Mueve el telÃ©fono para explorar":"Arrastra para explorar",s=document.createElement("div");s.id="v360-overlay",s.innerHTML=`\n      <canvas id="v360-canvas"></canvas>\n      <div id="v360-loading"><div class="v360-spinner"></div></div>\n      <div id="v360-topbar">\n        <button id="v360-back">\n          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"\n               stroke="currentColor" stroke-width="2.2"\n               stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="15 18 9 12 15 6"/>\n          </svg>\n          Mapa AR\n        </button>\n        <span id="v360-title">${this._fmt(e)}</span>\n      </div>\n      ${n?"":'<div id="v360-gyro-badge">Modo tÃ¡ctil</div>'}\n      ${a>1?`\n        <button class="v360-nav" id="v360-prev" aria-label="Anterior">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"\n               stroke="currentColor" stroke-width="2.2"\n               stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="15 18 9 12 15 6"/>\n          </svg>\n        </button>\n        <button class="v360-nav" id="v360-next" aria-label="Siguiente">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"\n               stroke="currentColor" stroke-width="2.2"\n               stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="9 18 15 12 9 6"/>\n          </svg>\n        </button>\n        <div id="v360-counter">\n          ${Array.from({length:a},(e,t)=>`<div class="v360-dot${0===t?" active":""}"></div>`).join("")}\n        </div>`:""}\n      <span id="v360-hint">${r}</span>\n    `,document.body.appendChild(s),this.overlay=s,s.querySelector("#v360-back").addEventListener("click",()=>this.close(i)),a>1&&(s.querySelector("#v360-prev").addEventListener("click",async()=>{const e=t.navigatePrev();e&&await this._navTo(e,t)}),s.querySelector("#v360-next").addEventListener("click",async()=>{const e=t.navigateNext();e&&await this._navTo(e,t)})),requestAnimationFrame(()=>s.classList.add("v360-visible"))}async _navTo(e,t){this._showLoading(),this._updateTitle(e),this._updateDots(t),this._drag.lon=0,this._drag.lat=0,await this._loadImage(e),this._hideLoading()}_updateTitle(e){const t=this.overlay?.querySelector("#v360-title");t&&(t.textContent=this._fmt(e))}_updateDots(e){const t=this.overlay?.querySelectorAll(".v360-dot");if(!t)return;const n=e.idx;t.forEach((e,t)=>e.classList.toggle("active",t===n))}_showLoading(){this.overlay?.querySelector("#v360-loading")?.classList.remove("v360-hidden")}_hideLoading(){this.overlay?.querySelector("#v360-loading")?.classList.add("v360-hidden")}_hideHintAfterDelay(){setTimeout(()=>{this.overlay?.querySelector("#v360-hint")?.classList.add("v360-hidden")},3500)}_fmt(e){return e.replace(/_/g," ")}_initRenderer(){const{THREE:e}=this,t=document.getElementById("v360-canvas");this.renderer=new e.WebGLRenderer({canvas:t,antialias:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),this.scene=new e.Scene,this.camera=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.texLoader=new e.TextureLoader,this._euler=new e.Euler,this._q1=new e.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._qOrient=new e.Quaternion,this._zee=new e.Vector3(0,0,1)}async _loadImage(e){const{THREE:t}=this;this.sphere&&(this.scene.remove(this.sphere),this.sphere.material.dispose(),this.sphere.geometry.dispose(),this.sphere=null);let n=this.texCache.get(e)??null;n||(n=await new Promise(t=>{this.texLoader.load(`assets/360/${e}.jpg`,t,void 0,()=>t(null))}),n&&(n.colorSpace=t.SRGBColorSpace??t.sRGBEncoding,this.texCache.set(e,n)));const i=new t.SphereGeometry(500,60,40);i.scale(-1,1,1),this.sphere=new t.Mesh(i,new t.MeshBasicMaterial({map:n??null,color:n?16777215:1714746})),this.scene.add(this.sphere)}_fullDispose(){this.sphere&&(this.sphere.geometry.dispose(),this.sphere.material.dispose(),this.sphere=null),this.texCache.forEach(e=>e.dispose()),this.texCache.clear(),this.renderer?.dispose(),this.renderer=this.scene=this.camera=null}async _requestGyroPermission(){const e=DeviceOrientationEvent;if("function"==typeof e?.requestPermission)try{if("granted"!==await e.requestPermission())return!1}catch{return!1}return function(e=1500){return new Promise(t=>{let n=!1;const i=e=>{n||null!==e.alpha&&(n=!0,window.removeEventListener("deviceorientation",i),t(!0))};window.addEventListener("deviceorientation",i),setTimeout(()=>{n||(n=!0,window.removeEventListener("deviceorientation",i),t(!1))},e)})}(1200)}_startGyro(){this._gyroOk=!0,this._gyroHandler=e=>{null!==e.alpha&&(this._alpha=e.alpha,this._beta=e.beta??90,this._gamma=e.gamma??0)},window.addEventListener("deviceorientation",this._gyroHandler)}_stopGyro(){this._gyroHandler&&(window.removeEventListener("deviceorientation",this._gyroHandler),this._gyroHandler=null),this._gyroOk=!1}_startTouchDrag(){const e=this._drag;this._onTouchStart=t=>{1===t.touches.length&&(e.active=!0,e.lastX=t.touches[0].clientX,e.lastY=t.touches[0].clientY)},this._onTouchMove=t=>{e.active&&1===t.touches.length&&(e.lon-=.25*(t.touches[0].clientX-e.lastX),e.lat+=.15*(t.touches[0].clientY-e.lastY),e.lat=Math.max(-85,Math.min(85,e.lat)),e.lastX=t.touches[0].clientX,e.lastY=t.touches[0].clientY)},this._onTouchEnd=()=>{e.active=!1};const t=document.getElementById("v360-canvas");t.addEventListener("touchstart",this._onTouchStart,{passive:!0}),t.addEventListener("touchmove",this._onTouchMove,{passive:!0}),t.addEventListener("touchend",this._onTouchEnd,{passive:!0})}_stopTouchDrag(){const e=document.getElementById("v360-canvas");e&&(this._onTouchStart&&e.removeEventListener("touchstart",this._onTouchStart),this._onTouchMove&&e.removeEventListener("touchmove",this._onTouchMove),this._onTouchEnd&&e.removeEventListener("touchend",this._onTouchEnd),this._onTouchStart=this._onTouchMove=this._onTouchEnd=null)}_startLoop(){const{THREE:e}=this,t=()=>{if(this.renderer){if(this.rafId=requestAnimationFrame(t),this._gyroOk){const t=e.MathUtils.degToRad(this._alpha),n=e.MathUtils.degToRad(this._beta),i=e.MathUtils.degToRad(this._gamma),a=e.MathUtils.degToRad(window.screen?.orientation?.angle??window.orientation??0);this._euler.set(n,t,-i,"YXZ"),this.camera.quaternion.setFromEuler(this._euler),this.camera.quaternion.multiply(this._q1),this._qOrient.setFromAxisAngle(this._zee,-a),this.camera.quaternion.multiply(this._qOrient)}else{const t=e.MathUtils.degToRad(90-this._drag.lat),n=e.MathUtils.degToRad(this._drag.lon);this.camera.lookAt(500*Math.sin(t)*Math.cos(n),500*Math.cos(t),500*Math.sin(t)*Math.sin(n))}this.renderer.render(this.scene,this.camera)}};t()}}const h=.28,p=1e-5;function u(e){for(const{mesh:t,original:n}of e)t.material=n;e.length=0}let m=null;e.registerComponent({name:"terrain-tap-place",schema:{ground:e.eid,terrainEntity:e.eid},schemaDefaults:{},data:{placed:e.boolean},stateMachine:({world:n,eid:a,schemaAttribute:r,dataAttribute:d})=>{const g=r.get(a),{THREE:v}=window,f=[];let y=null,b=!1,w=!1,x=!1;const _=new i,E=new o,T=new c(v),S=new s(v,{baseSize:.4,verticalOffset:.025,debug:!1,onHotspotTap:e=>{b||(b=!0,y?.detach(),_.hideResetButton(),T.open(e,E,()=>{b=!1,w=!0}))}}),k=e.defineTrigger(),L=e.defineTrigger(),H=e.defineTrigger(),C=()=>n.three.entityToObject.get(g.terrainEntity)??null,M=()=>{n.setPosition(g.terrainEntity,0,-9999,0),e.Scale.set(n,g.terrainEntity,{x:p,y:p,z:p})},A=()=>{(async()=>{y?.detach(),y=null,S.dispose(n.three.scene),u(f),M(),x=!0,await new Promise(e=>{if(m)return void e();const t=document.createElement("div");t.style.cssText="\n      position:fixed; inset:0; z-index:88888;\n      background:#000; pointer-events:all;\n      opacity:0; transition:opacity 0.2s ease;\n    ",document.body.appendChild(t),m=t,requestAnimationFrame(()=>{t.style.opacity="1",setTimeout(e,220)})});const e=document.querySelector('canvas[id^="XR"]')??document.querySelector("canvas:not(#v360-canvas)");e&&await async function(e){const t=window.XR8;t&&(t.stop(),await new Promise(e=>setTimeout(e,350)),t.run({canvas:e}))}(e),w=!0})()};e.defineState("loading").initial().onEnter(()=>{!function(){const e=navigator.userAgent,t=/iP(hone|ad|od)/.test(e),n=/Android/.test(e);(t||n)&&(/Safari/.test(e)||/Chrome/.test(e)||/CriOS/.test(e))||l({icon:"ðŸŒ",iconType:"warn",title:"Dispositivo no compatible con AR",message:"Este dispositivo o navegador no admite experiencias AR. Puedes explorar el mapa en la versiÃ³n 3D interactiva.",primary:"Ver versiÃ³n 3D",secondary:"Continuar de todas formas",onPrimary:()=>{window.location.href="https://virtualtours.interiors3d.com/3d-model/fvg-unesco_test/fullscreen/"},onSecondary:()=>{}})}(),async function(){try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(e=>e.stop())}catch(e){const t=e.name;"NotAllowedError"===t||"PermissionDeniedError"===t?l({icon:"ðŸ“·",iconType:"error",title:"Acceso a cÃ¡mara denegado",message:"Esta experiencia AR necesita la cÃ¡mara. Ve a ConfiguraciÃ³n â†’ Privacidad â†’ CÃ¡mara y habilita el acceso para este navegador.",primary:"Entendido",onPrimary:()=>{}}):("NotReadableError"===t||"TrackStartError"===t)&&l({icon:"ðŸ“·",iconType:"warn",title:"CÃ¡mara en uso",message:"Otra aplicaciÃ³n estÃ¡ usando la cÃ¡mara. CiÃ©rrala y vuelve a intentarlo.",primary:"Reintentar",onPrimary:()=>window.location.reload()})}}(),M(),e.Hidden.has(n,g.terrainEntity)&&e.Hidden.remove(n,g.terrainEntity),_.showLoader()}).onTick(()=>{(function(e,t){const n=e.three.entityToObject.get(t);if(!n)return!1;let i=!1;return n.traverse(e=>{i||e.isMesh&&e.geometry?.attributes&&Object.keys(e.geometry.attributes).length>0&&(i=!0)}),i})(n,g.terrainEntity)&&k.trigger()}).onTrigger(k,"scanning"),e.defineState("scanning").onEnter(()=>{M(),u(f),d.cursor(a).placed=!1,_.showRescanLoader()}).onTick(()=>{const t=n.raycastFrom(a).filter(e=>e.eid===g.ground);if(0===t.length)return;const i=t[0].point,r=e.Position.get(n,a),{x:s,z:o}=function(e,t,n,i,a){const r=new e.Vector3(i-t,0,a-n);return r.lengthSq()<1e-4?{x:t,z:n}:(r.normalize(),{x:t+.6*r.x,z:n+.6*r.z})}(v,i.x,i.z,r.x,r.z),l=i.y+1;n.setPosition(g.terrainEntity,s,l,o),e.Scale.set(n,g.terrainEntity,{x:h,y:h,z:h}),x&&(function(){if(!m)return;const e=m;m=null,e.style.opacity="0",setTimeout(()=>e.remove(),320)}(),x=!1),_.hideLoader(),L.trigger()}).onTrigger(L,"placed"),e.defineState("placed").onEnter(async()=>{y?.detach(),y=new t(g.terrainEntity,n,v),y.attach(),S.dispose(n.three.scene);const e=C();if(e){const t=await S.init(e,n.three.scene);E.register(t)}_.showResetButton(A),d.cursor(a).placed=!0}).onTick(()=>{if(w)return w=!1,void H.trigger();if(b)return;const e=C();e&&S.update(e)}).onExit(()=>{y?.detach(),y=null,S.dispose(n.three.scene),_.hideResetButton()}).onTrigger(H,"scanning")},remove:()=>{}});const g=JSON.parse('{"entrySpaceId":"terrain-ar-space-01","objects":{"terrain-ar-camera-01":{"camera":{"allowedDevices":"any","type":"perspective","xr":{"phone":"AR","xrCameraType":"world","desktop":"disabled","headset":"disabled"}},"components":{"terrain-tap-place-comp-01":{"id":"terrain-tap-place-comp-01","name":"terrain-tap-place","parameters":{"ground":{"type":"entity","id":"terrain-ar-ground-01"},"terrainEntity":{"type":"entity","id":"terrain-ar-model-01"},"yHeight":0.005,"finalScale":1}}},"geometry":null,"id":"terrain-ar-camera-01","material":null,"name":"Camera","order":1,"parentId":"terrain-ar-space-01","position":[0,2,2],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ambient-01":{"components":{},"geometry":null,"id":"terrain-ar-ambient-01","light":{"type":"ambient","intensity":1.2},"material":null,"name":"Ambient Light","order":2,"parentId":"terrain-ar-space-01","position":[0,5,0],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-dirlight-01":{"components":{},"id":"terrain-ar-dirlight-01","light":{"castShadow":true,"color":"#ffffff","intensity":1,"type":"directional","shadowAutoUpdate":true,"shadowBias":0.001,"shadowMapSize":[1024,1024],"shadowCameraLeft":-5,"shadowCameraRight":5,"shadowCameraTop":5,"shadowCameraBottom":-5,"shadowCameraNear":0.5,"shadowCameraFar":50,"targetX":0,"targetY":0,"targetZ":0},"name":"Directional Light","order":2.5,"parentId":"terrain-ar-space-01","position":[10,15,8],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ground-01":{"components":{},"geometry":{"height":1000,"type":"plane","width":1000},"id":"terrain-ar-ground-01","material":{"color":"#000000","opacity":0,"side":"double","transparent":true,"type":"shadow"},"name":"Ground","order":3,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[-0.7071068,0,0,0.7071068],"scale":[1,1,1],"shadow":{"receiveShadow":true}},"terrain-ar-model-01":{"components":{},"gltfModel":{"animationClip":"","loop":false,"src":{"type":"asset","asset":"assets/terrain_optimized3.glb"}},"id":"terrain-ar-model-01","name":"Terrain Model","order":4,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[0,0,0,1],"scale":[1,1,1],"shadow":{"castShadow":true,"receiveShadow":true}}},"runtimeVersion":{"type":"version","level":"major","major":2,"minor":0,"patch":0},"spaces":{"terrain-ar-space-01":{"activeCamera":"terrain-ar-camera-01","id":"terrain-ar-space-01","name":"Terrain AR","reflections":{"type":"url","url":"https://cdn.8thwall.com/web/assets/envmap/basic_env_map-m9hqpneh.jpg"}}},"historyVersion":"terrain-ar-v1"}');delete g.history,delete g.historyVersion,window.ecs.application.init(g)})();