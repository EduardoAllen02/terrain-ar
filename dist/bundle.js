(()=>{"use strict";const t=window.ecs;t.registerComponent({name:"Coaching Overlay",schema:{scene:t.eid},stateMachine:({world:e,eid:r,schemaAttribute:n})=>{t.defineState("default").initial().listen(e.events.globalId,t.events.REALITY_TRACKING_STATUS,a=>{const{scene:i}=n.get(r);"LIMITED"===a.data.status?(t.Hidden.remove(e,r),t.Hidden.set(e,i)):"NORMAL"===a.data.status&&(t.Hidden.set(e,r),t.Hidden.remove(e,i))})}});class e{constructor(t,e){this.scene=t,this.THREE=e,this.points=null}create(){const{THREE:t}=this,r=e.DOT_COUNT,n=new Float32Array(3*r);for(let t=0;t<r;t++){const a=t/(r-1);n[3*t]=0,n[3*t+1]=a*e.TOWER_HEIGHT,n[3*t+2]=0}const a=new t.BufferGeometry;a.setAttribute("position",new t.BufferAttribute(n,3));const i=new t.PointsMaterial({color:16777215,size:e.DOT_SIZE,map:this._getSoftCircleTexture(),transparent:!0,opacity:e.DOT_OPACITY,depthWrite:!1,sizeAttenuation:!0,alphaTest:.01});this.points=new t.Points(a,i),this.scene.add(this.points)}update(t,e,r){this.points&&this.points.position.set(t,e,r)}setVisible(t){this.points&&(this.points.visible=t)}fadeAndDispose(t=350){if(!this.points)return;const r=this.points.material,n=performance.now(),a=e.DOT_OPACITY,i=()=>{const e=Math.min((performance.now()-n)/t,1);r.opacity=a*(1-e),e<1?requestAnimationFrame(i):this._dispose()};requestAnimationFrame(i)}dispose(){this._dispose()}_getSoftCircleTexture(){if(e.cachedTexture)return e.cachedTexture;const t=document.createElement("canvas");t.width=64,t.height=64;const r=t.getContext("2d"),n=r.createRadialGradient(32,32,0,32,32,32);n.addColorStop(0,"rgba(255,255,255,1.00)"),n.addColorStop(.4,"rgba(255,255,255,0.95)"),n.addColorStop(.7,"rgba(255,255,255,0.40)"),n.addColorStop(1,"rgba(255,255,255,0.00)"),r.fillStyle=n,r.fillRect(0,0,64,64);const{THREE:a}=this;return e.cachedTexture=new a.CanvasTexture(t),e.cachedTexture}_dispose(){this.points&&(this.scene.remove(this.points),this.points.geometry.dispose(),this.points.material.dispose(),this.points=null)}}e.cachedTexture=null,e.DOT_COUNT=9,e.TOWER_HEIGHT=1.35,e.DOT_SIZE=.055,e.DOT_OPACITY=.92;const r=(()=>{let t=!1;return()=>{if(t)return;t=!0;const e=document.createElement("style");e.textContent="\n      @keyframes ar-pulse {\n        0%, 100% { opacity: 1; transform: scale(1); }\n        50%       { opacity: 0.4; transform: scale(0.75); }\n      }\n    ",document.head.appendChild(e)}})();class n{constructor(){this.container=null,this.dotEl=null,this.textEl=null}show(){r(),this.container||(this.container=document.createElement("div"),this.container.id="terrain-ar-ui",this.container.style.cssText="\n  position: fixed;\n  bottom: 100px;\n  left: 50%;\n  transform: translateX(-50%) translateY(10px);\n  opacity: 0;\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  background: rgba(8, 10, 28, 0.78);\n  backdrop-filter: blur(12px);\n  -webkit-backdrop-filter: blur(12px);\n  border: 1px solid rgba(79, 195, 247, 0.35);\n  border-radius: 100px;\n  padding: 10px 22px 10px 16px;\n  color: #e8f4ff;\n  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n  font-size: 13px;\n  font-weight: 300;\n  letter-spacing: 0.12em;\n  text-transform: uppercase;\n  pointer-events: none;\n  z-index: 9999;\n  white-space: nowrap;\n  transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),\n              transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);\n  will-change: opacity, transform;\n",this.dotEl=document.createElement("span"),this.dotEl.style.cssText="\n  width: 7px;\n  height: 7px;\n  border-radius: 50%;\n  background: #4fc3f7;\n  flex-shrink: 0;\n  animation: ar-pulse 1.6s ease-in-out infinite;\n",this.textEl=document.createElement("span"),this.textEl.textContent=n.MESSAGES.scanning,this.container.appendChild(this.dotEl),this.container.appendChild(this.textEl),document.body.appendChild(this.container),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.container&&(this.container.style.opacity="1",this.container.style.transform="translateX(-50%) translateY(0)")})}))}setState(t){if(this.textEl&&(this.textEl.textContent=n.MESSAGES[t],this.dotEl)){const e={scanning:"#4fc3f7","ground-found":"#69f0ae",placed:"#69f0ae"};this.dotEl.style.background=e[t]}}hide(t=600){if(!this.container)return;const e=this.container;this.container=null,this.dotEl=null,this.textEl=null,setTimeout(()=>{e.style.opacity="0",e.style.transform="translateX(-50%) translateY(10px)",setTimeout(()=>e.remove(),380)},t)}}n.MESSAGES={scanning:"Apunta al piso","ground-found":"Toca para colocar",placed:"Mapa colocado"};const a=.3;t.registerComponent({name:"terrain-tap-place",schema:{ground:t.eid,terrainEntity:t.eid,yHeight:t.f32,finalScale:t.f32},schemaDefaults:{yHeight:.005,finalScale:1},data:{cursorX:t.f32,cursorY:t.f32,cursorZ:t.f32,landX:t.f32,landY:t.f32,landZ:t.f32,groundHit:t.boolean,lastElapsed:t.f32,landProgress:t.f32,landFromY:t.f32},stateMachine:({world:r,eid:i,schemaAttribute:o,dataAttribute:s})=>{const c=o.get(i),l=[];let d=null;const u=new n;let g=!1;const p=t.defineTrigger(),h=t.defineTrigger(),m=()=>r.three.entityToObject.get(c.terrainEntity)??null;t.defineState("scanning").initial().onEnter(()=>{const{THREE:n}=window;d=new e(r.three.scene,n),d.create(),t.Hidden.set(r,c.terrainEntity),g=!1;const a=s.cursor(i);a.lastElapsed=r.time.elapsed,a.groundHit=!1,u.show(),u.setState("scanning")}).onTick(()=>{(()=>{const t=r.time.elapsed,e=s.cursor(i);Math.min((t-e.lastElapsed)/1e3,.1);e.lastElapsed=t})();const e=r.raycastFrom(i).filter(t=>t.eid===c.ground),n=e.length>0,o=s.cursor(i);if(o.groundHit=n,n){const{x:n,y:i,z:s}=e[0].point;o.cursorX+=.18*(n-o.cursorX),o.cursorY=c.yHeight,o.cursorZ+=.18*(s-o.cursorZ),d?.update(o.cursorX,o.cursorY,o.cursorZ),(()=>{if(g)return;const t=m();t&&(function(t,e,r){r.length=0;const n=new t.MeshStandardMaterial({color:9350852,roughness:.75,metalness:.05,transparent:!0,opacity:.7});e.traverse(t=>{t.isMesh&&(r.push({mesh:t,original:Array.isArray(t.material)?t.material.slice():t.material}),t.material=Array.isArray(t.material)?t.material.map(()=>n):n)})}(window.THREE,t,l),g=!0)})(),t.Hidden.has(r,c.terrainEntity)&&t.Hidden.remove(r,c.terrainEntity),r.setPosition(c.terrainEntity,o.cursorX,o.cursorY+1.35,o.cursorZ),t.Scale.set(r,c.terrainEntity,{x:a,y:a,z:a});const p=m();p&&(p.rotation.y+=.007),u.setState("ground-found")}else d?.update(o.cursorX,o.cursorY,o.cursorZ),t.Hidden.has(r,c.terrainEntity)||t.Hidden.set(r,c.terrainEntity),u.setState("scanning")}).listen(r.events.globalId,t.input.SCREEN_TOUCH_START,()=>{const t=s.get(i);if(!t.groundHit)return;const e=s.cursor(i);e.landX=t.cursorX,e.landY=t.cursorY,e.landZ=t.cursorZ,e.landFromY=t.cursorY+1.35,e.landProgress=0,p.trigger()}).onTrigger(p,"landing"),t.defineState("landing").onEnter(()=>{!function(t){for(const{mesh:e,original:r}of t)e.material=r;t.length=0}(l),g=!1;const t=m();t&&(t.rotation.y=0),d&&(d.fadeAndDispose(300),d=null),u.setState("placed"),u.hide(900)}).onTick(()=>{const e=s.cursor(i);e.landProgress=Math.min(e.landProgress+1/(600/16.67),1);const n=e.landProgress,o=1-Math.pow(1-n,3),l=e.landFromY+(e.landY-e.landFromY)*o,d=a+(c.finalScale-a)*o;r.setPosition(c.terrainEntity,e.landX,l,e.landZ),t.Scale.set(r,c.terrainEntity,{x:d,y:d,z:d}),e.landProgress>=1&&h.trigger()}).onTrigger(h,"placed"),t.defineState("placed").onEnter(()=>{const e=s.get(i),n=c.finalScale;r.setPosition(c.terrainEntity,e.landX,e.landY,e.landZ),t.Scale.set(r,c.terrainEntity,{x:n,y:n,z:n})})},remove:(t,e)=>{}}),t.registerComponent({name:"gesture-detection",schema:{twoFingerDrag:t.boolean,holdDrag:t.boolean,pinchScale:t.boolean,groundEntity:t.eid,rotationFactor:t.f32,dragDelay:t.i32,minScale:t.f32,maxScale:t.f32,scaleFactor:t.f32,dragSmoothness:t.f32,rotationSmoothness:t.f32},schemaDefaults:{twoFingerDrag:!0,holdDrag:!0,pinchScale:!0,rotationFactor:3,dragDelay:300,minScale:.3,maxScale:8,scaleFactor:2,dragSmoothness:.15,rotationSmoothness:.12},data:{currentGesture:t.string,holdTimer:t.i32,isDragging:t.boolean,lastTouchX:t.f32,lastTouchY:t.f32,dragStartY:t.f32,targetX:t.f32,targetY:t.f32,targetZ:t.f32,currentX:t.f32,currentY:t.f32,currentZ:t.f32,lastAngle:t.f32,rotationY:t.f32,targetRotationY:t.f32,currentRotationY:t.f32,initialSpread:t.f32,initialScale:t.f32},stateMachine:({world:e,eid:r,schemaAttribute:n,dataAttribute:a,defineState:i})=>{const o=t.defineTrigger(),s=t.defineTrigger(),c=t.defineTrigger(),l=t.defineTrigger();i("waiting").initial().onEnter(()=>{const n=t.Scale.get(e,r);a.set(r,{currentGesture:"none",holdTimer:0,isDragging:!1,lastTouchX:0,lastTouchY:0,dragStartY:0,lastAngle:0,rotationY:0,targetRotationY:0,currentRotationY:0,initialSpread:0,initialScale:n.x,targetX:0,targetY:0,targetZ:0,currentX:0,currentY:0,currentZ:0})}).listen(r,t.input.SCREEN_TOUCH_START,t=>{const i=n.get(r),s=a.cursor(r);i.holdDrag&&(s.holdTimer=e.time.setTimeout(()=>{o.trigger()},i.dragDelay))}).listen(e.events.globalId,t.input.GESTURE_START,t=>{const e=t.data,i=n.get(r),o=a.cursor(r);2===e.touchCount&&(i.twoFingerDrag||i.pinchScale)&&(o.initialSpread=e.spread,s.trigger())}).listen(e.events.globalId,t.input.SCREEN_TOUCH_END,t=>{const n=a.cursor(r);0!==n.holdTimer&&(e.time.clearTimeout(n.holdTimer),n.holdTimer=0)}).onTrigger(o,"holdDrag").onTrigger(s,"twoFinger").onTrigger(c,"dropping"),i("holdDrag").onEnter(()=>{const t=a.cursor(r);t.isDragging=!0,t.currentGesture="holdDrag";const n=e.transform.getWorldPosition(r);t.dragStartY=n.y,t.currentX=n.x,t.currentY=n.y,t.currentZ=n.z,t.targetX=n.x,t.targetY=n.y+.2,t.targetZ=n.z}).onTick(()=>{const t=n.get(r),i=a.cursor(r);if(!(i.isDragging||Math.abs(i.currentY-i.targetY)>.01||Math.abs(i.currentX-i.targetX)>.01||Math.abs(i.currentZ-i.targetZ)>.01))return;const o=t.dragSmoothness;i.currentX+=(i.targetX-i.currentX)*o,i.currentY+=(i.targetY-i.currentY)*o,i.currentZ+=(i.targetZ-i.currentZ)*o,e.transform.setWorldPosition(r,{x:i.currentX,y:i.currentY,z:i.currentZ})}).listen(e.events.globalId,t.input.SCREEN_TOUCH_MOVE,t=>{const i=t.data,o=n.get(r),s=a.cursor(r);if(!i.position)return;const{THREE:c}=window;let l=null;if(e.three.scene.traverse(t=>{t.isCamera&&!l&&(l=t)}),!l)return;const d=2*i.position.x-1,u=-(2*i.position.y-1),g=new c.Raycaster;g.setFromCamera(new c.Vector2(d,u),l);const p=e.three.entityToObject.get(o.groundEntity);if(!p)return;const h=g.intersectObject(p,!0);if(h.length>0){const t=h[0].point;s.targetX=t.x,s.targetY=s.dragStartY+.2,s.targetZ=t.z}}).listen(e.events.globalId,t.input.SCREEN_TOUCH_END,t=>{const e=a.cursor(r);e.targetX=e.currentX,e.targetY=e.dragStartY,e.targetZ=e.currentZ,c.trigger()}).onExit(()=>{const t=a.cursor(r);t.isDragging=!1,t.currentGesture="none"}).onTrigger(c,"dropping"),i("dropping").onEnter(()=>{a.cursor(r).currentGesture="dropping"}).onTick(()=>{const t=n.get(r),i=a.cursor(r);if(!(Math.abs(i.currentY-i.targetY)>.01||Math.abs(i.currentX-i.targetX)>.01||Math.abs(i.currentZ-i.targetZ)>.01))return void l.trigger();const o=t.dragSmoothness;i.currentX+=(i.targetX-i.currentX)*o,i.currentY+=(i.targetY-i.currentY)*o,i.currentZ+=(i.targetZ-i.currentZ)*o,e.transform.setWorldPosition(r,{x:i.currentX,y:i.currentY,z:i.currentZ})}).onExit(()=>{a.cursor(r).currentGesture="none"}).onTrigger(l,"waiting"),i("twoFinger").onEnter(()=>{const i=a.cursor(r),o=n.get(r);i.currentGesture="twoFinger",o.twoFingerDrag&&(i.lastAngle=0),o.pinchScale&&(i.initialScale=t.Scale.get(e,r).x)}).listen(e.events.globalId,t.input.GESTURE_MOVE,i=>{const o=i.data,s=n.get(r),c=a.cursor(r);if(s.twoFingerDrag&&2===o.touchCount&&o.positionChange){const t=(o.positionChange.x??0)*s.rotationFactor;if(0===t)return;const n=.5*t,a=Math.sin(n),i=Math.cos(n);e.transform.rotateSelf(r,{x:0,y:a,z:0,w:i})}if(s.pinchScale&&void 0!==o.spread&&c.initialSpread>0&&2===o.touchCount){const n=o.spread/c.initialSpread;let a=c.initialScale*n;a=Math.max(s.minScale,Math.min(s.maxScale,a)),t.Scale.set(e,r,{x:a,y:a,z:a})}}).listen(e.events.globalId,t.input.GESTURE_END,n=>{n.data;const i=a.cursor(r);t.Scale.has(e,r)&&(i.initialScale=t.Scale.get(e,r).x),i.initialSpread=0,l.trigger()}).onExit(()=>{a.cursor(r).currentGesture="none"}).onTrigger(l,"waiting")},remove:(t,e)=>{const{dataAttribute:r,eid:n}=e;0!==r.get(n).holdTimer&&t.time.clearTimeout(r.get(n).holdTimer)}});const i=JSON.parse('{"entrySpaceId":"terrain-ar-space-01","objects":{"terrain-ar-camera-01":{"camera":{"allowedDevices":"any","type":"perspective","xr":{"phone":"AR","xrCameraType":"world","desktop":"disabled","headset":"disabled"}},"components":{"terrain-tap-place-comp-01":{"id":"terrain-tap-place-comp-01","name":"terrain-tap-place","parameters":{"ground":{"type":"entity","id":"terrain-ar-ground-01"},"terrainEntity":{"type":"entity","id":"terrain-ar-model-01"},"yHeight":0.005,"finalScale":1}}},"geometry":null,"id":"terrain-ar-camera-01","material":null,"name":"Camera","order":1,"parentId":"terrain-ar-space-01","position":[0,2,2],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ambient-01":{"components":{},"geometry":null,"id":"terrain-ar-ambient-01","light":{"type":"ambient","intensity":1.2},"material":null,"name":"Ambient Light","order":2,"parentId":"terrain-ar-space-01","position":[0,5,0],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-dirlight-01":{"components":{},"id":"terrain-ar-dirlight-01","light":{"castShadow":true,"color":"#ffffff","intensity":1,"type":"directional","shadowAutoUpdate":true,"shadowBias":0.001,"shadowMapSize":[1024,1024],"shadowCameraLeft":-5,"shadowCameraRight":5,"shadowCameraTop":5,"shadowCameraBottom":-5,"shadowCameraNear":0.5,"shadowCameraFar":50,"targetX":0,"targetY":0,"targetZ":0},"name":"Directional Light","order":2.5,"parentId":"terrain-ar-space-01","position":[10,15,8],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ground-01":{"components":{},"geometry":{"height":1000,"type":"plane","width":1000},"id":"terrain-ar-ground-01","material":{"color":"#000000","opacity":0,"side":"double","transparent":true,"type":"shadow"},"name":"Ground","order":3,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[-0.7071068,0,0,0.7071068],"scale":[1,1,1],"shadow":{"receiveShadow":true}},"terrain-ar-model-01":{"components":{},"gltfModel":{"animationClip":"","loop":false,"src":{"type":"asset","asset":"assets/terrain_optimized3.glb"}},"hidden":true,"id":"terrain-ar-model-01","name":"Terrain Model","order":4,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[0,0,0,1],"scale":[1,1,1],"shadow":{"castShadow":true,"receiveShadow":true}}},"runtimeVersion":{"type":"version","level":"major","major":2,"minor":0,"patch":0},"spaces":{"terrain-ar-space-01":{"activeCamera":"terrain-ar-camera-01","id":"terrain-ar-space-01","name":"Terrain AR","reflections":{"type":"url","url":"https://cdn.8thwall.com/web/assets/envmap/basic_env_map-m9hqpneh.jpg"}}},"historyVersion":"terrain-ar-v1"}');delete i.history,delete i.historyVersion,window.ecs.application.init(i)})();