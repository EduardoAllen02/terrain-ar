(()=>{"use strict";const t=window.ecs;t.registerComponent({name:"Coaching Overlay",schema:{scene:t.eid},stateMachine:({world:e,eid:r,schemaAttribute:n})=>{t.defineState("default").initial().listen(e.events.globalId,t.events.REALITY_TRACKING_STATUS,a=>{const{scene:i}=n.get(r);"LIMITED"===a.data.status?(t.Hidden.remove(e,r),t.Hidden.set(e,i)):"NORMAL"===a.data.status&&(t.Hidden.set(e,r),t.Hidden.remove(e,i))})}});class e{constructor(t,e){this.scene=t,this.THREE=e,this.points=null,this.elapsed=0}create(){const{THREE:t}=this,r=e.DOT_COUNT;this.posArray=new Float32Array(3*r);const n=new t.BufferGeometry;n.setAttribute("position",new t.BufferAttribute(this.posArray,3));const a=new t.PointsMaterial({color:5227511,size:e.DOT_SIZE,transparent:!0,opacity:.88,depthWrite:!1,sizeAttenuation:!0});this.points=new t.Points(n,a),this.elapsed=0,this._writeDotPositions(),this.scene.add(this.points)}update(t,e,r,n){this.points&&(this.elapsed+=n,this.points.position.set(t,e,r),this._writeDotPositions())}setVisible(t){this.points&&(this.points.visible=t)}fadeAndDispose(t=400){if(!this.points)return;const e=this.points.material,r=performance.now(),n=()=>{const a=Math.min((performance.now()-r)/t,1);e.opacity=.88*(1-a),a<1?requestAnimationFrame(n):this._dispose()};requestAnimationFrame(n)}dispose(){this._dispose()}_writeDotPositions(){const t=e.DOT_COUNT,r=e.TOWER_HEIGHT,n=e.HELIX_RADIUS,a=e.HELIX_TURNS,i=e.FLOW_SPEED,o=e.ROTATION_SPEED;for(let e=0;e<t;e++){const s=(e/t+this.elapsed*i)%1,c=s*r,l=s*Math.PI*2*a+this.elapsed*o,d=n*(1+.35*Math.sin(1.7*e+.8*this.elapsed));this.posArray[3*e]=Math.cos(l)*d,this.posArray[3*e+1]=c,this.posArray[3*e+2]=Math.sin(l)*d}this.points&&(this.points.geometry.attributes.position.needsUpdate=!0)}_dispose(){this.points&&(this.scene.remove(this.points),this.points.geometry.dispose(),this.points.material.dispose(),this.points=null)}}e.DOT_COUNT=70,e.TOWER_HEIGHT=1.4,e.HELIX_RADIUS=.014,e.HELIX_TURNS=3,e.FLOW_SPEED=.45,e.ROTATION_SPEED=.4,e.DOT_SIZE=.011;const r=(()=>{let t=!1;return()=>{if(t)return;t=!0;const e=document.createElement("style");e.textContent="\n      @keyframes ar-pulse {\n        0%, 100% { opacity: 1; transform: scale(1); }\n        50%       { opacity: 0.4; transform: scale(0.75); }\n      }\n    ",document.head.appendChild(e)}})();class n{constructor(){this.container=null,this.dotEl=null,this.textEl=null}show(){r(),this.container||(this.container=document.createElement("div"),this.container.id="terrain-ar-ui",this.container.style.cssText="\n  position: fixed;\n  bottom: 100px;\n  left: 50%;\n  transform: translateX(-50%) translateY(10px);\n  opacity: 0;\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  background: rgba(8, 10, 28, 0.78);\n  backdrop-filter: blur(12px);\n  -webkit-backdrop-filter: blur(12px);\n  border: 1px solid rgba(79, 195, 247, 0.35);\n  border-radius: 100px;\n  padding: 10px 22px 10px 16px;\n  color: #e8f4ff;\n  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\n  font-size: 13px;\n  font-weight: 300;\n  letter-spacing: 0.12em;\n  text-transform: uppercase;\n  pointer-events: none;\n  z-index: 9999;\n  white-space: nowrap;\n  transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),\n              transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);\n  will-change: opacity, transform;\n",this.dotEl=document.createElement("span"),this.dotEl.style.cssText="\n  width: 7px;\n  height: 7px;\n  border-radius: 50%;\n  background: #4fc3f7;\n  flex-shrink: 0;\n  animation: ar-pulse 1.6s ease-in-out infinite;\n",this.textEl=document.createElement("span"),this.textEl.textContent=n.MESSAGES.scanning,this.container.appendChild(this.dotEl),this.container.appendChild(this.textEl),document.body.appendChild(this.container),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.container&&(this.container.style.opacity="1",this.container.style.transform="translateX(-50%) translateY(0)")})}))}setState(t){if(this.textEl&&(this.textEl.textContent=n.MESSAGES[t],this.dotEl)){const e={scanning:"#4fc3f7","ground-found":"#69f0ae",placed:"#69f0ae"};this.dotEl.style.background=e[t]}}hide(t=600){if(!this.container)return;const e=this.container;this.container=null,this.dotEl=null,this.textEl=null,setTimeout(()=>{e.style.opacity="0",e.style.transform="translateX(-50%) translateY(10px)",setTimeout(()=>e.remove(),380)},t)}}n.MESSAGES={scanning:"Apunta al piso","ground-found":"Toca para colocar",placed:"Mapa colocado"};const a=.28;t.registerComponent({name:"terrain-tap-place",schema:{ground:t.eid,terrainEntity:t.eid,yHeight:t.f32,finalScale:t.f32},schemaDefaults:{yHeight:.005,finalScale:1},data:{finalPositionX:t.f32,finalPositionY:t.f32,finalPositionZ:t.f32,groundDetected:t.boolean,lastElapsed:t.f32},stateMachine:({world:r,eid:i,schemaAttribute:o,dataAttribute:s})=>{const c=o.get(i),l={x:0,y:0,z:0},d=t.defineTrigger();let p=null;const g=[],u=new n;let h=!1;const m=()=>r.three.entityToObject.get(c.terrainEntity)??null;t.defineState("scanning").initial().onEnter(()=>{const{THREE:n}=window;p=new e(r.three.scene,n),p.create(),t.Hidden.set(r,c.terrainEntity),h=!1,s.cursor(i).lastElapsed=r.time.elapsed,s.cursor(i).groundDetected=!1,u.show(),u.setState("scanning")}).onTick(()=>{const e=(()=>{const t=r.time.elapsed,e=s.cursor(i),n=Math.min((t-e.lastElapsed)/1e3,.1);return e.lastElapsed=t,n})(),n=s.cursor(i),o=r.raycastFrom(i).filter(t=>t.eid===c.ground),d=o.length>0;if(n.groundDetected=d,d){const{x:n,y:i,z:s}=o[0].point;l.x+=.25*(n-l.x),l.y=c.yHeight,l.z+=.25*(s-l.z),p?.update(l.x,l.y,l.z,e),(()=>{if(h)return;const t=m();if(!t)return;const{THREE:e}=window;!function(t,e,r){r.length=0,e.traverse(e=>{if(!e.isMesh)return;const n=Array.isArray(e.material)?e.material.slice():e.material;r.push({mesh:e,original:n});const a=new t.MeshStandardMaterial({color:9350852,roughness:.75,metalness:.05,transparent:!0,opacity:.72,wireframe:!1});Array.isArray(e.material)?e.material=e.material.map(()=>a):e.material=a})}(e,t,g),h=!0})(),t.Hidden.has(r,c.terrainEntity)&&t.Hidden.remove(r,c.terrainEntity),r.setPosition(c.terrainEntity,l.x,l.y+1.4,l.z),t.Scale.set(r,c.terrainEntity,{x:a,y:a,z:a});const d=m();d&&(d.rotation.y+=.008),u.setState("ground-found")}else p?.update(l.x,l.y,l.z,e),u.setState("scanning")}).listen(r.events.globalId,t.input.SCREEN_TOUCH_START,()=>{if(!s.get(i).groundDetected)return;const t=s.cursor(i);t.finalPositionX=l.x,t.finalPositionY=l.y,t.finalPositionZ=l.z,d.trigger()}).onTrigger(d,"placed"),t.defineState("placed").onEnter(()=>{const e=s.get(i);!function(t){for(const{mesh:e,original:r}of t)e.material=r;t.length=0}(g),h=!1;const n=m();n&&(n.rotation.y=0),r.setPosition(c.terrainEntity,e.finalPositionX,e.finalPositionY,e.finalPositionZ),t.Hidden.remove(r,c.terrainEntity);const o=c.finalScale;t.ScaleAnimation.set(r,i,{target:c.terrainEntity,loop:!1,duration:750,easeOut:!0,easingFunction:"Back",fromX:a,fromY:a,fromZ:a,toX:o,toY:o,toZ:o}),p&&(p.fadeAndDispose(350),p=null),u.setState("placed"),u.hide(800)})},remove:(t,e)=>{const{eid:r}=e}}),t.registerComponent({name:"gesture-detection",schema:{twoFingerDrag:t.boolean,holdDrag:t.boolean,pinchScale:t.boolean,groundEntity:t.eid,rotationFactor:t.f32,dragDelay:t.i32,minScale:t.f32,maxScale:t.f32,scaleFactor:t.f32,dragSmoothness:t.f32,rotationSmoothness:t.f32},schemaDefaults:{twoFingerDrag:!0,holdDrag:!0,pinchScale:!0,rotationFactor:3,dragDelay:300,minScale:.3,maxScale:8,scaleFactor:2,dragSmoothness:.15,rotationSmoothness:.12},data:{currentGesture:t.string,holdTimer:t.i32,isDragging:t.boolean,lastTouchX:t.f32,lastTouchY:t.f32,dragStartY:t.f32,targetX:t.f32,targetY:t.f32,targetZ:t.f32,currentX:t.f32,currentY:t.f32,currentZ:t.f32,lastAngle:t.f32,rotationY:t.f32,targetRotationY:t.f32,currentRotationY:t.f32,initialSpread:t.f32,initialScale:t.f32},stateMachine:({world:e,eid:r,schemaAttribute:n,dataAttribute:a,defineState:i})=>{const o=t.defineTrigger(),s=t.defineTrigger(),c=t.defineTrigger(),l=t.defineTrigger();i("waiting").initial().onEnter(()=>{const n=t.Scale.get(e,r);a.set(r,{currentGesture:"none",holdTimer:0,isDragging:!1,lastTouchX:0,lastTouchY:0,dragStartY:0,lastAngle:0,rotationY:0,targetRotationY:0,currentRotationY:0,initialSpread:0,initialScale:n.x,targetX:0,targetY:0,targetZ:0,currentX:0,currentY:0,currentZ:0})}).listen(r,t.input.SCREEN_TOUCH_START,t=>{const i=n.get(r),s=a.cursor(r);i.holdDrag&&(s.holdTimer=e.time.setTimeout(()=>{o.trigger()},i.dragDelay))}).listen(e.events.globalId,t.input.GESTURE_START,t=>{const e=t.data,i=n.get(r),o=a.cursor(r);2===e.touchCount&&(i.twoFingerDrag||i.pinchScale)&&(o.initialSpread=e.spread,s.trigger())}).listen(e.events.globalId,t.input.SCREEN_TOUCH_END,t=>{const n=a.cursor(r);0!==n.holdTimer&&(e.time.clearTimeout(n.holdTimer),n.holdTimer=0)}).onTrigger(o,"holdDrag").onTrigger(s,"twoFinger").onTrigger(c,"dropping"),i("holdDrag").onEnter(()=>{const t=a.cursor(r);t.isDragging=!0,t.currentGesture="holdDrag";const n=e.transform.getWorldPosition(r);t.dragStartY=n.y,t.currentX=n.x,t.currentY=n.y,t.currentZ=n.z,t.targetX=n.x,t.targetY=n.y+.2,t.targetZ=n.z}).onTick(()=>{const t=n.get(r),i=a.cursor(r);if(!(i.isDragging||Math.abs(i.currentY-i.targetY)>.01||Math.abs(i.currentX-i.targetX)>.01||Math.abs(i.currentZ-i.targetZ)>.01))return;const o=t.dragSmoothness;i.currentX+=(i.targetX-i.currentX)*o,i.currentY+=(i.targetY-i.currentY)*o,i.currentZ+=(i.targetZ-i.currentZ)*o,e.transform.setWorldPosition(r,{x:i.currentX,y:i.currentY,z:i.currentZ})}).listen(e.events.globalId,t.input.SCREEN_TOUCH_MOVE,t=>{const i=t.data,o=n.get(r),s=a.cursor(r);if(!i.position)return;const{THREE:c}=window;let l=null;if(e.three.scene.traverse(t=>{t.isCamera&&!l&&(l=t)}),!l)return;const d=2*i.position.x-1,p=-(2*i.position.y-1),g=new c.Raycaster;g.setFromCamera(new c.Vector2(d,p),l);const u=e.three.entityToObject.get(o.groundEntity);if(!u)return;const h=g.intersectObject(u,!0);if(h.length>0){const t=h[0].point;s.targetX=t.x,s.targetY=s.dragStartY+.2,s.targetZ=t.z}}).listen(e.events.globalId,t.input.SCREEN_TOUCH_END,t=>{const e=a.cursor(r);e.targetX=e.currentX,e.targetY=e.dragStartY,e.targetZ=e.currentZ,c.trigger()}).onExit(()=>{const t=a.cursor(r);t.isDragging=!1,t.currentGesture="none"}).onTrigger(c,"dropping"),i("dropping").onEnter(()=>{a.cursor(r).currentGesture="dropping"}).onTick(()=>{const t=n.get(r),i=a.cursor(r);if(!(Math.abs(i.currentY-i.targetY)>.01||Math.abs(i.currentX-i.targetX)>.01||Math.abs(i.currentZ-i.targetZ)>.01))return void l.trigger();const o=t.dragSmoothness;i.currentX+=(i.targetX-i.currentX)*o,i.currentY+=(i.targetY-i.currentY)*o,i.currentZ+=(i.targetZ-i.currentZ)*o,e.transform.setWorldPosition(r,{x:i.currentX,y:i.currentY,z:i.currentZ})}).onExit(()=>{a.cursor(r).currentGesture="none"}).onTrigger(l,"waiting"),i("twoFinger").onEnter(()=>{const i=a.cursor(r),o=n.get(r);i.currentGesture="twoFinger",o.twoFingerDrag&&(i.lastAngle=0),o.pinchScale&&(i.initialScale=t.Scale.get(e,r).x)}).listen(e.events.globalId,t.input.GESTURE_MOVE,i=>{const o=i.data,s=n.get(r),c=a.cursor(r);if(s.twoFingerDrag&&2===o.touchCount&&o.positionChange){const t=(o.positionChange.x??0)*s.rotationFactor;if(0===t)return;const n=.5*t,a=Math.sin(n),i=Math.cos(n);e.transform.rotateSelf(r,{x:0,y:a,z:0,w:i})}if(s.pinchScale&&void 0!==o.spread&&c.initialSpread>0&&2===o.touchCount){const n=o.spread/c.initialSpread;let a=c.initialScale*n;a=Math.max(s.minScale,Math.min(s.maxScale,a)),t.Scale.set(e,r,{x:a,y:a,z:a})}}).listen(e.events.globalId,t.input.GESTURE_END,n=>{n.data;const i=a.cursor(r);t.Scale.has(e,r)&&(i.initialScale=t.Scale.get(e,r).x),i.initialSpread=0,l.trigger()}).onExit(()=>{a.cursor(r).currentGesture="none"}).onTrigger(l,"waiting")},remove:(t,e)=>{const{dataAttribute:r,eid:n}=e;0!==r.get(n).holdTimer&&t.time.clearTimeout(r.get(n).holdTimer)}});const i=JSON.parse('{"entrySpaceId":"terrain-ar-space-01","objects":{"terrain-ar-camera-01":{"camera":{"allowedDevices":"any","type":"perspective","xr":{"phone":"AR","xrCameraType":"world","desktop":"disabled","headset":"disabled"}},"components":{"terrain-tap-place-comp-01":{"id":"terrain-tap-place-comp-01","name":"terrain-tap-place","parameters":{"ground":{"type":"entity","id":"terrain-ar-ground-01"},"terrainEntity":{"type":"entity","id":"terrain-ar-model-01"},"yHeight":0.005,"finalScale":1}}},"geometry":null,"id":"terrain-ar-camera-01","material":null,"name":"Camera","order":1,"parentId":"terrain-ar-space-01","position":[0,2,2],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ambient-01":{"components":{},"geometry":null,"id":"terrain-ar-ambient-01","light":{"type":"ambient","intensity":1.2},"material":null,"name":"Ambient Light","order":2,"parentId":"terrain-ar-space-01","position":[0,5,0],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-dirlight-01":{"components":{},"id":"terrain-ar-dirlight-01","light":{"castShadow":true,"color":"#ffffff","intensity":1,"type":"directional","shadowAutoUpdate":true,"shadowBias":0.001,"shadowMapSize":[1024,1024],"shadowCameraLeft":-5,"shadowCameraRight":5,"shadowCameraTop":5,"shadowCameraBottom":-5,"shadowCameraNear":0.5,"shadowCameraFar":50,"targetX":0,"targetY":0,"targetZ":0},"name":"Directional Light","order":2.5,"parentId":"terrain-ar-space-01","position":[10,15,8],"rotation":[0,0,0,1],"scale":[1,1,1]},"terrain-ar-ground-01":{"components":{},"geometry":{"height":1000,"type":"plane","width":1000},"id":"terrain-ar-ground-01","material":{"color":"#000000","opacity":0,"side":"double","transparent":true,"type":"shadow"},"name":"Ground","order":3,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[-0.7071068,0,0,0.7071068],"scale":[1,1,1],"shadow":{"receiveShadow":true}},"terrain-ar-model-01":{"components":{},"gltfModel":{"animationClip":"","loop":false,"src":{"type":"asset","asset":"assets/terrain_optimized3.glb"}},"hidden":true,"id":"terrain-ar-model-01","name":"Terrain Model","order":4,"parentId":"terrain-ar-space-01","position":[0,0,0],"rotation":[0,0,0,1],"scale":[1,1,1],"shadow":{"castShadow":true,"receiveShadow":true}}},"runtimeVersion":{"type":"version","level":"major","major":2,"minor":0,"patch":0},"spaces":{"terrain-ar-space-01":{"activeCamera":"terrain-ar-camera-01","id":"terrain-ar-space-01","name":"Terrain AR","reflections":{"type":"url","url":"https://cdn.8thwall.com/web/assets/envmap/basic_env_map-m9hqpneh.jpg"}}},"historyVersion":"terrain-ar-v1"}');delete i.history,delete i.historyVersion,window.ecs.application.init(i)})();